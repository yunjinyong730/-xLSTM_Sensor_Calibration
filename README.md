# TimeXer — 외생 변수(Exogenous)를 활용하는 트랜스포머 기반 시계열 예측

> **한 줄 요약**  
> TimeXer는 내생(예측 대상) 시계열은 **패치 단위(Self-Attention)** 로, 외생(보조) 시계열은 **변수 단위(Cross-Attention)** 로 처리하며, **글로벌 토큰**을 매개로 두 정보를 정교하게 결합해 다양한 벤치마크에서 SOTA 성능을 보이는 간단·일반 목적의 트랜스포머 설계이다.

---

## 목차
- [핵심 아이디어](#핵심-아이디어)
- [문제 정의](#문제-정의)
- [모델 아키텍처](#모델-아키텍처)
  - [내생 임베딩: 패치 + 글로벌 토큰](#내생-임베딩-패치--글로벌-토큰)
  - [외생 임베딩: 변수(시계열) 단일 토큰](#외생-임베딩-변수시계열-단일-토큰)
  - [듀얼 어텐션: 패치-자기어텐션 & 변수-크로스어텐션](#듀얼-어텐션-패치-자기어텐션--변수-크로스어텐션)
  - [출력 & 학습](#출력--학습)
- [왜 이렇게 설계했나? (디자인 논리)](#왜-이렇게-설계했나-디자인-논리)
- [실험 결과 요약](#실험-결과-요약)
- [어블레이션 & 분석](#어블레이션--분석)
- [현실 환경 대응력(일반화): 누락/불일치/스케일](#현실-환경-대응력일반화-누락불일치스케일)
- [멀티변수 예측으로의 자연스러운 확장](#멀티변수-예측으로의-자연스러운-확장)
- [복잡도/효율성](#복잡도효율성)
- [한계와 권장 사용처](#한계와-권장-사용처)
- [재현 팁(실무 가이드)](#재현-팁실무-가이드)
- [인용](#인용)

---

## 핵심 아이디어
- **역할 분리:**  
  - **내생(Endogenous)** = 우리가 예측할 목표. 시점 간 **국소/장기 패턴**이 핵심 → 패치 단위 토큰화 후 **Self-Attention**.  
  - **외생(Exogenous)** = 예측에 도움 주는 보조 변수. 센서마다 결측/주기/길이 등이 다름 → **시계열 전체를 하나의 변수 토큰**으로 요약 후 **Cross-Attention**으로 내생 쪽에 주입.
- **글로벌 토큰(learnable)**: 내생 시계열별로 1개. 외생 정보가 **직접 패치로 흘러가기 전 거점** 역할(브리지).
- **구성품 교체 없이** 표준 Transformer 블록만으로 구현(임베딩/토큰화 전략으로 기능을 부여).

---

## 문제 정의
주어진 내생 시계열 \(x_{1:T}\in\mathbb{R}^{T\times 1}\) 과 다수 외생 \(z^{(i)}_{1:T_{\text{ex}}}\in\mathbb{R}^{T_{\text{ex}}\times C}\) 로 **미래 \(S\) 스텝**을 예측:

$$
\hat{x}_{T+1:T+S} = F_\theta\!\left(x_{1:T},\, z_{1:T_{\text{ex}}}\right)
$$

시계열 길이 \(T\) 와 \(T_{\text{ex}}\) 는 **달라도 무방**하여 현실의 주기/길이 불일치를 수용.

---

## 모델 아키텍처

### 내생 임베딩: 패치 + 글로벌 토큰
- 내생 \(x\) 를 길이 \(P\) 의 **비중첩 패치**로 분할:  
  \(\{s_i\}_{i=1}^N,\; N=\lfloor T/P \rfloor\)
- 각 패치를 선형 임베딩 → **패치 토큰** \(P_{\text{en}}\in\mathbb{R}^{N\times D}\)
- 시계열 전역 표현을 담는 **학습형 글로벌 토큰** \(G_{\text{en}}\in\mathbb{R}^{1\times D}\) 추가

### 외생 임베딩: 변수(시계열) 단일 토큰
- 각 외생 시계열 \(z^{(i)}\) 전체를 선형 투영 → **변수 토큰** \(V^{(i)}_{\text{ex}}\in\mathbb{R}^{1\times D}\)
- 패치처럼 세분하지 않음 → **결측/미스얼라인/상이한 주기·길이**에 강인, 노이즈·계산량 감소

### 듀얼 어텐션: 패치-자기어텐션 & 변수-크로스어텐션
- **Endogenous Self-Attention(Temporal-wise)**: \([P_{\text{en}}, G_{\text{en}}]\)에 표준 Self-Attention
  - **Patch→Patch:** 패치 간 시간 의존성 학습  
  - **Patch↔Global:** 전역 문맥↔국소 패치 상호작용(전역 요약/전역 주입)
- **Exogenous→Endogenous Cross-Attention(Variate-wise)**:
  - **Query:** \(G_{\text{en}}\) (내생 전역)  
  - **Key/Value:** \(V_{\text{ex}}=\{V^{(i)}_{\text{ex}}\}_{i=1}^C\) (외생 집합)  
  - 외생 정보를 전역 토큰을 경유해 **관련 패치**로 선별 전파

### 출력 & 학습
- 최종 \([P_{\text{en}}^{(L)}, G_{\text{en}}^{(L)}]\)를 선형 프로젝션하여 \(\hat{x}\) 생성, **L2 손실**로 학습
- **디코더 불필요**: Encoder-only 예측기 형태

---

## 왜 이렇게 설계했나? (디자인 논리)
- 외생을 패치 단위로 세분하면 **복잡도↑/노이즈↑**. 변수 단일 토큰이면 **불규칙성**(결측·주기/길이 불일치)에 자연 내성
- 내생은 패치 단위가 필수(국소 패턴·시계 구조 보존)
- **글로벌 토큰**이 외생↔내생 패치 간 **인과적 신호 흐름의 허브** 역할

---

## 실험 결과 요약
- **단기 전력가격(EPF, 입력168→출력24):** 5개 마켓 **모두 SOTA**(MSE/MAE 기준)
- **장기 다변량(ETT/ECL/Traffic/Weather 등, 입력96→다양한 예측길이):** 대부분 데이터셋에서 **일관된 우위**
- **대규모 날씨(3,850 스테이션, ERA5 외생 36개/3시간 주기):** 보간 없이 **주기 불일치** 상황에서 타 모델 상회

> 외생 주입을 정교화한 설계가 **iTransformer(변수-중심)**, **PatchTST(패치-중심)** 각각의 약점을 보완. Crossformer처럼 **모든 변수×패치** 상호작용을 강제할 때의 불필요한 비용/혼선을 회피

---

## 어블레이션 & 분석
- **임베딩 대체/제거/결합**(외생 패치화, 글로벌 제거 등) → 전반적으로 성능 하락
- **Cross-Attention 제거** 후 단순 덧셈/결합 → 정보 혼선·잡음 유입으로 악화
- **패치 길이 \(P\)** 변화(2~24): 평균 성능 큰 변동 없음. 단, **너무 작은 \(P\)** 는 패턴 표현력 저하
- **오버랩 패치**는 비중첩 대비 **복잡도↑**에 비해 이점 제한
- **어텐션맵 해석:** 내생과 **형태 유사** 외생에 주목(물리적 상관성과 부합)

---

## 현실 환경 대응력(일반화): 누락/불일치/스케일
- **외생 결측/랜덤화:** 성능 소폭 하락에 그침 → 내생 패치 표현이 **주도적으로** 예측을 안정화  
- **내생 결측/랜덤화:** 예측 불가 → 성능 급락(예상된 결과)  
- **과거 길이 증가:** 내·외생 모두 늘리면 대체로 향상. 특히 **내생 길이 증가** 이득이 큼  
- **주기/길이 불일치:** (예: 외생 3시간, 내생 1시간) 변수 토큰화로 **직접 처리**, 별도 보간 불필요  
- **대규모 변수(수백~수천):** 외생-외생 상호작용 생략으로 **메모리/시간 효율** 우수

---

## 멀티변수 예측으로의 자연스러운 확장
다변량 시계열의 각 변수를 **차례로 내생**, 나머지를 **외생**으로 보고 병렬 적용(채널 독립 가정).  
동일 Self/Cross-Attention 층을 **공유**하여 모든 변수의 예측을 동시 산출 가능.

---

## 복잡도/효율성
- iTransformer: **모든 변수 토큰 간** Self-Attention → 비용 증가
- TimeXer: **외생↔내생 전역 토큰** 사이 Cross-Attention만 수행 → **외생-외생 상호작용 생략**, **메모리/시간 감소**
- 대규모 외생 변수가 많은 데이터(ECL 320변수 등)에서 **유의미한 절감**

---

## 한계와 권장 사용처
- **한계:** 외생 간 상호작용이 중요한 과제(예: 외생끼리 강한 동학)에서는 외생-외생 어텐션을 추가한 변형이 더 나을 수 있음
- **권장 사용처**
  - 외생의 **결측/미스얼라인/주기·길이 불일치**가 잦은 현실 문제(전력가격, 기상, 교통, 수요예측)
  - 변수 수가 많고 **효율**이 중요한 환경
  - 디코더 없이 **단순·안정**한 엔코더형 예측기를 원하는 경우

---

## 재현 팁(실무 가이드)
- **입력 윈도우/패치 길이**
  - 단기(시간당 데이터, 24~168h 윈도우): \(P=24\) 를 기본값으로 추천  
  - 장기(분·시간 혼재): \(P\in\{8,16\}\) 먼저 시도. 너무 작은 \(P\) 는 지양
- **외생 전처리**
  - 결측/불일치 허용 → **보간 최소화**(필요 시 스케일링/클리핑 정도)
  - 수백 변수 이상이면 변수 선택(상관/도메인 지식)으로 **C** 축소 시 학습 안정화
- **학습**
  - 옵티마이저: Adam, 학습률 약 \(1\times 10^{-4}\) 시작, 조기 종료  
  - 블록 수 \(L\in\{1,2,3\}\), 히든 \(D\in\{128,256,512\}\) 탐색
- **해석**
  - Cross-Attention **가중치**로 외생 변수 **기여도** 파악(설명가능성)
- **멀티변수 예측**
  - 채널 독립 병렬 추론으로 배치 효율 확보. 필요 시 출력 후 **스태킹 앙상블** 고려

---

## 인용
이 README 정리는 업로드된 논문 **TimeXer**를 기반으로 작성되었습니다. 구현 및 수치, 도식, 하이퍼파라미터, 데이터셋 구성 등 자세한 내용은 원문을 참조하세요.

---

> ⚠️ 본 문서는 저장소 `README.md`에 바로 붙여넣기 가능한 **마크다운 최적화** 버전입니다. 필요 시 **그림/수식 강조**, **한국어/영문 병기**, **프로젝트 구조/설치 안내 섹션**도 추가해 드릴 수 있습니다.
